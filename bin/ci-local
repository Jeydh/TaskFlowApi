#!/usr/bin/env bash
set -e

echo "==> Validate composer.json"
composer validate --strict

echo "==> Install dependencies"
composer install --prefer-dist --no-progress --no-suggest --optimize-autoloader


echo "==> Prepare test DB"
php bin/console doctrine:fixtures:load --no-interaction --env=test

php bin/console doctrine:database:drop --if-exists --force --env=test
php bin/console doctrine:database:create --if-not-exists --env=test
php bin/console doctrine:migrations:migrate --no-interaction --env=test --no-interaction
php bin/console doctrine:fixtures:load --no-interaction --env=test --no-interaction --purge-with-truncate || true

echo "==> Warmup cache (PHPStan Symfony extension)"
php bin/console cache:warmup --env=test || true

echo "==> PHPStan"
composer phpstan

echo "==> PHPUnit"
php bin/phpunit --testdox